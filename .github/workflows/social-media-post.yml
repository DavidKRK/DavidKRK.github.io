name: Social Media Auto-Post

on:
  push:
    branches: [gh-pages]
    paths:
      - 'music.html'
      - 'assets/music/**'
  workflow_dispatch:
    inputs:
      message:
        description: 'Custom message to post'
        required: false
        default: 'ðŸŽµ New track available on davidkrk.com'

permissions:
  contents: read
  issues: write

jobs:
  detect-new-music:
    name: Detect New Music & Generate Social Post
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 2

      - name: Check for music changes
        id: changes
        run: |
          if git diff HEAD^ HEAD -- music.html | grep -q 'music-item'; then
            echo "new_music=true" >> $GITHUB_OUTPUT
            echo "ðŸŽµ New music detected!"
          else
            echo "new_music=false" >> $GITHUB_OUTPUT
            echo "No new music found"
          fi

      - name: Extract new track info
        if: steps.changes.outputs.new_music == 'true'
        id: track_info
        run: |
          # Extract the last added track title from music.html
          TRACK_TITLE=$(grep -oP '(?<=<h3>).*?(?=</h3>)' music.html | tail -1)
          echo "track_title=$TRACK_TITLE" >> $GITHUB_OUTPUT
          echo "Detected track: $TRACK_TITLE"

      - name: Generate social media post content
        if: steps.changes.outputs.new_music == 'true'
        id: generate_post
        run: |
          TRACK="${{ steps.track_info.outputs.track_title }}"
          
          cat << SOCIALPOST > social_post.txt
          ðŸŽµ NEW TRACK ALERT! ðŸŽµ
          
          "$TRACK" is now available!
          
          ðŸŽ§ Listen now: https://www.davidkrk.com/music.html
          
          #DavidKRK #NewMusic #DJ #Producer #ElectronicMusic #TechHouse
          SOCIALPOST
          
          cat social_post.txt

      - name: Create notification issue
        if: steps.changes.outputs.new_music == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const postContent = fs.readFileSync('social_post.txt', 'utf8');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ“± Ready to post: ${{ steps.track_info.outputs.track_title }}',
              body: `## Social Media Post Ready\n\n${postContent}\n\n---\n\n**Next steps:**\n1. Copy the content above\n2. Post manually on your social networks\n3. Close this issue when done\n\n**Auto-posting is ready but requires API keys for:**\n- Facebook Pages API\n- Instagram Graph API\n- Twitter API v2\n\nTo enable auto-posting, add these secrets to your repository.`,
              labels: ['social-media', 'automated', 'new-music']
            });

      - name: Save post for future auto-posting
        if: steps.changes.outputs.new_music == 'true'
        run: |
          mkdir -p .social-posts
          DATE=$(date +%Y-%m-%d_%H-%M-%S)
          cp social_post.txt ".social-posts/post_$DATE.txt"
          echo "Social post saved for future auto-posting"

  # Future: uncomment when API keys are configured
  # post-to-facebook:
  #   needs: detect-new-music
  #   if: needs.detect-new-music.outputs.new_music == 'true'
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Post to Facebook
  #       env:
  #         FB_PAGE_TOKEN: ${{ secrets.FB_PAGE_TOKEN }}
  #       run: |
  #         curl -X POST "https://graph.facebook.com/v18.0/me/feed" \
  #           -d "message=$(cat social_post.txt)" \
  #           -d "access_token=$FB_PAGE_TOKEN"
